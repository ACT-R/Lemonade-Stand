
<head>

  <!-- Import Blockly -->
  <script type="text/javascript" src="lib/google-blockly/blockly_compressed.js"></script>
  <script type="text/javascript" src="lib/google-blockly/msg/js/en.js"></script>
  <script type="text/javascript" src="lib/google-blockly/javascript_compressed.js"></script>
  <script type="text/javascript" src="blockly/act-r.js"></script>

  <!-- Import ACE Editor -->
  <script type="text/javascript" src="lib/ace-builds/src-min/ace.js"></script>

  <!-- Import XTerm Styles -->
  <link href="lib/xterm/index.css" rel="stylesheet" type="text/css" />

  <!-- Meta -->
  <title>ACT-R Lemonade Stand</title>
  <link rel="icon" sizes="16x16 32x32 48x48" href="/img/favicon.ico">

</head>

<body>

  <div class="panel-container">
    <div class="resizable-horiz panel-left">
      <ul class="tabs">
        <li style="padding-top:6px; margin:0 10px;"> ACT-R Lemonade Stand </li>
        <li><a href="#block_editor">Block Editor</a></li>
        <li><a href="#code_editor">Code Editor</a></li>
        <li><a href="#getting_started">Getting Started</a></li>
        <li class="right play"><a href="#block_editor" id="play" onclick="runModel()"><span class="ui-icon ui-icon-play"></span></a></li>
        <li class="right save"><a href="#block_editor" id="save" onclick="saveModel()"><span class="ui-icon ui-icon-disk"></span></a></li>
        <li class="right load ui-state-default ui-corner-top">
          <div class="ui-tabs-anchor">
            <span class="ui-icon ui-icon-folder-open" style="float:left; margin-right: 6px;"></span>
            <select name="load_model" id="load_model">
              <option value="models/blank.xml" selected="selected">Blank</option>
              <option value="models/blank.xml">Unit 1</option>
              <option value="models/blank.xml">Unit 2</option>
              <option value="models/blank.xml">Unit 3</option>
              <option value="models/blank.xml">Unit 4</option>
              <option value="models/blank.xml">Unit 5</option>
            </select>
          </div>
        </li>
      </ul>

      <div id="block_editor">
        {{> actr_blockly}}
        {{> blockly}}
      </div>

      <div id="code_editor">
        {{> ace}}
      </div>

      <div id="getting_started">
        <iframe src="guide/index.html" scrolling="auto" frameborder="0"></iframe>
      </div>

    </div>
    <div class="resizable-horiz panel-right">
      <div class="panel-top">
        <div class="ct-chart">
        </div>
      </div>

      <div class="terminal panel-bottom">
        {{> lisp_output}}
      </div>
    </div>
  </div>

  <!-- Footer -->

</body>

<!-- BLOCKLY -->
<template name="blockly">
  <div id="blockly_div"></div>
  <div id="blockly_area"></div>
</template>

<template name="actr_blockly">
  <xml id="toolbox" style="display: none">
    <block type="production"></block>
    <block type="production_component"></block>
    <block type="production_slot"></block>
    <block type="symbol"></block>
    <block type="variable"></block>

  </xml>
</template>

<!-- ACE -->
<template name="ace">
  <div id="ace_editor">

  ;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;      YOUR MODEL     ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;

  ;;BEGIN-MODEL
  (define-model lemonade

    ;;
    ;; SET PARAMETERS
    ;;
    (sgp :v nil)

    ;;
    ;; GOAL BUFFER DEFINITION
    ;;
    ;; Abstract Game State Type
    (chunk-type game-state state)
    (define-chunks (purchase isa chunk) (learn isa chunk))

    ;; Purchase Stage Type
    (chunk-type (game-purchase (:include game-state))
      (state purchase)
      weather_temperature
      weather_condition
      inventory_lemons
      inventory_sugar
      inventory_ice
      inventory_cups
    )

    ;; Learn Stage Type
    (chunk-type (game-learn (:include game-state))
      (state learn)
      score
    )

    ;; Create Goal Focus
    (declare-buffer-usage goal game-state :all)

    ;; Example Key Press
    (p test-keypress-l
     =goal>
       isa game-purchase
       state purchase
     ?manual>
       state free
    ==>
     =goal>
       state purchase-l
     +manual>
       cmd press-key
       key "l"
      )

      (p test-keypress-s
       =goal>
         isa game-purchase
         state purchase-l
       ?manual>
         state free
      ==>
       =goal>
         state purchase-s
       +manual>
         cmd press-key
         key "s"
        )

      (p test-keypress-i
       =goal>
         isa game-purchase
         state purchase-s
       ?manual>
         state free
      ==>
       =goal>
         state purchase-i
       +manual>
         cmd press-key
         key "i"
        )

        (p test-keypress-c
         =goal>
           isa game-purchase
           state purchase-i
         ?manual>
           state free
        ==>
         =goal>
           state nil
         +manual>
           cmd press-key
           key "c"
          )

  )
  ;;END-MODEL

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;   PURCHASE FUNCTION   ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;

  (defvar *response*)
  (defmethod rpm-window-key-event-handler ((win rpm-window) key)
      (cond
        ((string-equal key "l") (setf (nth 0 *response*) "1"))
        ((string-equal key "s") (setf (nth 1 *response*) "1"))
        ((string-equal key "i") (setf (nth 2 *response*) "1"))
        ((string-equal key "c") (setf (nth 3 *response*) "1"))
      )
  )

  (defun get-response ()
    (format nil "~{~A~^, ~}" *response*)
  )

  (defun purchase-stage (weather inventory)
    (let ((window (open-exp-window "Purchase Phase" :visible nil)))

        (install-device window)
        (setf *response* '("0" "0" "0" "0"))

        ;; Construct Goal Buffer Contents
        (let ((purchase `(
            state purchase
            weather_temperature ,(nth 0 weather)
            weather_condition ,(nth 1 weather)
            inventory_lemons ,(nth 0 inventory)
            inventory_sugar ,(nth 1 inventory)
            inventory_ice ,(nth 2 inventory)
            inventory_cups ,(nth 3 inventory)
          )))

          ;; Insert into Goal Buffer
          (if (buffer-read 'goal)
             (mod-focus-fct purchase)
             (goal-focus-fct (car (define-chunks-fct `(,(append '(isa game-state) purchase)))))
          )
        )

        ;; Run Model
        (run 10)

        ;; Return Response
        (get-response)

      )
  )

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;     LEARN FUNCTION    ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;

  (defun learn-stage (score)
    (let ((window (open-exp-window "Purchase Phase" :visible nil)))

      (install-device window)

      ;; Construct Goal Buffer Contents
      (let ((learn `(
          state learn
          score ,score
        )))

        (if (buffer-read 'goal)
           (mod-focus-fct learn)
           (goal-focus-fct (car (define-chunks-fct `(,(append '(isa game-state) learn)))))
        )
      )

      ;; Run Model
      (run-full-time 10)

      (values)
    )
  )
  </div>
</template>

<!-- LISP_OUTPUT -->
<template name="lisp_output">
  {{#if isActive}}
    {{#each getLines}}
      {{formatLine data}}
    {{/each}}
  {{else}}
    <div>
      Play model to see output...
    </div>
  {{/if}}
</template>
